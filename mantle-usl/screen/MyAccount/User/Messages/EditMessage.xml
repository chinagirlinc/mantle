<?xml version="1.0" encoding="UTF-8"?>
<!--
This is free and unencumbered software released into the public domain.
For specific language governing permissions and limitations refer to
the LICENSE.md file or http://unlicense.org
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-1.5.xsd"
        default-menu-title="Message" default-menu-index="1">

    <parameter name="communicationEventId" required="true"/>

    <transition name="updateMessage"><service-call name="update#mantle.party.communication.CommunicationEvent"/>
        <default-response url="."/></transition>
    <transition name="updateStatus"><service-call name="update#mantle.party.communication.CommunicationEvent"/>
        <default-response url="."/></transition>

    <transition name="messageThread"><default-response url="../MessageThread"/></transition>
    <transition name="replyMessage">
        <service-call name="mantle.party.CommunicationServices.reply#CommunicationEvent" in-map="context"/>
        <default-response url="../MessageThread"/>
    </transition>

    <actions>
        <entity-find-one entity-name="mantle.party.communication.CommunicationEvent" value-field="commEvent"/>
        <set field="statusId" from="commEvent.statusId"/>
        <set field="changedEntityName" value="mantle.party.communication.CommunicationEvent"/>
        <set field="pkPrimaryValue" from="commEvent.communicationEventId"/>
    </actions>
    <widgets>
        <label text="${commEvent.subject ?: 'Message'}" type="h2"/>

        <link url="messageThread" text="Thread"/>
        <container-dialog id="ReplyDialog" button-text="Reply">
            <form-single name="ReplyMessageForm" transition="replyMessage">
                <field name="communicationEventId"><default-field><hidden/></default-field></field>
                <field name="parentCommEventId" entry-name="communicationEventId"><default-field><hidden/></default-field></field>
                <field name="subject"><default-field><text-line default-value="Re: ${commEvent.subject}" size="60"/></default-field></field>
                <field name="body"><default-field title=""><text-area rows="10" cols="80"/></default-field></field>
                <field name="submitButton"><default-field title="Reply"><submit/></default-field></field>
                <field-layout>
                    <field-ref name="subject"/>
                    <field-row-big><field-ref name="body"/></field-row-big>
                    <field-ref name="submitButton"/>
                </field-layout>
            </form-single>
        </container-dialog>
        <section-include name="StatusChangeSection" location="component://mantle-usl/template/basic/StatusWidgets.xml"/>

        <container style="row">
            <container style="col-lg-8">
                <form-single name="MessageForm" map="commEvent" transition="updateMessage">
                    <field name="communicationEventId"><default-field><hidden/></default-field></field>

                    <field name="fromPartyId"><default-field title="From">
                        <display-entity entity-name="mantle.party.PartyDetail" also-hidden="false" key-field-name="partyId"
                                text="${organizationName?:''}${firstName?:''} ${lastName?:''}"/>
                    </default-field></field>
                    <field name="toPartyId"><default-field title="To">
                        <display-entity entity-name="mantle.party.PartyDetail" also-hidden="false" key-field-name="partyId"
                                text="${organizationName?:''}${firstName?:''} ${lastName?:''}"/>
                    </default-field></field>

                    <field name="communicationEventTypeId"><default-field title="Type">
                        <display-entity entity-name="mantle.party.communication.CommunicationEventType"/>
                    </default-field></field>

                    <field name="body"><default-field title=""><text-area cols="110" rows="16"/></default-field></field>

                    <field name="submitButton"><default-field title="Update"><submit/></default-field></field>

                    <field-layout>
                        <field-row><field-ref name="fromPartyId"/><field-ref name="toPartyId"/></field-row>
                        <fields-not-referenced/>
                        <field-row-big><field-ref name="body"/></field-row-big>
                        <field-ref name="submitButton"/>
                    </field-layout>
                </form-single>
            </container>
            <container style="col-lg-4">
                <section-include name="StatusHistorySection" location="component://mantle-usl/template/basic/StatusWidgets.xml"/>
            </container>
        </container>
    </widgets>
</screen>
